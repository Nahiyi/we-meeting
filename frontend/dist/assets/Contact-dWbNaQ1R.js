import{d as Se,u as Ne,V as Ae,r as c,y as se,n as Te,W as V,X as H,G as Ue,Y as Ee,s as C,w as l,Z as ne,b as a,e as o,c as v,v as $,_ as Me,g as r,$ as le,f as h,h as d,t as m,a0 as De,a1 as oe,F as J,z as ie,B as Le,a2 as xe,a3 as Be,a4 as Pe,a5 as be,D as ze,E as I,a6 as Ve,a7 as He,a8 as $e,o as n,P as re}from"./index-Dg42PXJN.js";import{A as Ke}from"./AppShell-CnOUhuHU.js";import{A as f,l as Re,a as Ge,C as E,b as Fe,c as Je,s as Xe,d as We,o as ce,e as ue}from"./contact-DFPDkY7g.js";import{_ as Oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ye={class:"contact-page"},Ze={class:"contact-left"},je={class:"search-section"},qe={class:"search-box"},Qe={key:0,class:"search-result"},et={class:"search-result-card"},tt={class:"result-avatar"},at={class:"result-info"},st={class:"result-name"},nt={class:"result-id"},lt={class:"result-action"},ot={class:"contact-list-section"},it={class:"section-header"},rt={class:"contact-count"},ct={key:0,class:"loading-state"},ut={key:1,class:"empty-state"},dt={key:2,class:"contact-list"},vt=["onClick"],ft={key:0,class:"online-dot"},pt={class:"contact-info"},mt={class:"contact-name"},_t={class:"contact-status"},yt={class:"contact-right"},gt={class:"section-header"},ht={key:0,class:"pending-badge"},Ct={key:0,class:"loading-state"},It={key:1,class:"empty-state"},kt={key:2,class:"apply-list"},wt={class:"apply-avatar"},St={class:"apply-info"},Nt={class:"apply-name"},At={class:"apply-time"},Tt={class:"apply-actions"},Ut={class:"private-chat-container"},Et=Se({__name:"Contact",setup(Mt){const M=Ne(),D=Ae(),S=c(""),K=c(!1),u=c(null),L=c(!1),x=c([]),R=c(!1),B=c([]),G=c(!1),P=c(null),N=c(null),X=se(()=>D.unreadCounts),A=c(!1),_=c(null),y=c([]),k=c(!1),w=c(!0),T=c(null),W=se(()=>B.value.filter(e=>e.status===f.INIT).length);async function U(){R.value=!0;try{x.value=await Re()}catch(e){console.error("加载联系人失败:",e)}finally{R.value=!1}}async function O(){G.value=!0;try{B.value=await Ge()}catch(e){console.error("加载好友申请失败:",e)}finally{G.value=!1}}async function Y(){if(!S.value.trim()){I.warning("请输入用户ID");return}K.value=!0,u.value=null;try{const e=await Xe(S.value.trim());e?u.value=e:I.info("未找到该用户")}catch(e){console.error("搜索失败:",e)}finally{K.value=!1}}async function Z(){if(u.value){L.value=!0;try{await Je(u.value.userId)===f.PASS?(I.success("添加成功"),U()):I.success("申请已发送"),u.value=null,S.value=""}catch(e){console.error("添加好友失败:",e)}finally{L.value=!1}}}async function j(e,t){P.value=e;try{await We(e,t),I.success(t===f.PASS?"已同意":"已拒绝"),O(),t===f.PASS&&U()}catch(i){console.error("处理申请失败:",i)}finally{P.value=null}}function de(e){if(!e)return"";const t=new Date(e),p=new Date().getTime()-t.getTime(),g=Math.floor(p/(1e3*60*60*24));return g===0?t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):g===1?"昨天":g<7?`${g}天前`:t.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})}function ve(e){switch(e){case f.PASS:return"success";case f.REJECT:return"info";case f.BLACKLIST:return"danger";default:return"info"}}function fe(e){switch(e){case f.PASS:return"已同意";case f.REJECT:return"已拒绝";case f.BLACKLIST:return"已拉黑";default:return"待处理"}}async function pe(e,t){try{await re.confirm(`确定要删除好友 "${t}" 吗？`,"删除好友",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),N.value=e,await ce(e,ue.DEL),I.success("已删除"),U()}catch(i){i!=="cancel"&&console.error("删除联系人失败:",i)}finally{N.value=null}}async function me(e,t){try{await re.confirm(`确定要拉黑 "${t}" 吗？拉黑后对方将无法向你发送消息。`,"拉黑好友",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),N.value=e,await ce(e,ue.BLACK),I.success("已拉黑"),U()}catch(i){i!=="cancel"&&console.error("拉黑联系人失败:",i)}finally{N.value=null}}function _e(e,t){e==="delete"?pe(t.contactId,t.contactNickName):e==="blacklist"?me(t.contactId,t.contactNickName):e==="chat"&&q(t)}async function q(e){_.value=e,y.value=[],w.value=!0,T.value=null,A.value=!0,await ye(),D.getUnreadCount(e.contactId)>0&&(await ne(e.contactId),D.clearUnread(e.contactId))}async function ye(){if(!(!_.value||k.value)){k.value=!0;try{const e=await Ve(_.value.contactId,1,20);e.list&&e.list.length>0?(y.value=e.list.map(Q).reverse(),T.value=Math.min(...e.list.map(t=>t.messageId)),w.value=e.list.length>=20):w.value=!1}catch(e){console.error("加载私聊历史失败:",e)}finally{k.value=!1}}}async function ge(){if(!(!_.value||k.value||!w.value||!T.value)){k.value=!0;try{const e=await He(_.value.contactId,T.value,20);if(e.list&&e.list.length>0){const t=e.list.map(Q).reverse();y.value=[...t,...y.value],T.value=Math.min(...e.list.map(i=>i.messageId)),w.value=e.list.length>=20}else w.value=!1}catch(e){console.error("加载更多私聊消息失败:",e)}finally{k.value=!1}}}async function he(e){if(!_.value)return;const t={sendUserId:M.userId,sendUserNickName:M.nickName,content:e,messageContent:e,sendTime:Date.now()};y.value.push(t);try{const i=await $e(_.value.contactId,5,e);t.messageId=i.messageId}catch(i){console.error("发送私聊消息失败:",i),I.error("发送失败");const p=y.value.indexOf(t);p>-1&&y.value.splice(p,1)}}function Q(e){return{messageId:e.messageId,sendUserId:e.sendUserId,sendUserNickName:e.sendUserNickName,content:e.messageContent,messageContent:e.messageContent,sendTime:e.sendTime}}function b(e){var t;if(e.messageSendToType===0&&e.sendUserId!==M.userId&&(console.log("Contact.vue: 收到私聊消息:",e),A.value&&((t=_.value)==null?void 0:t.contactId)===e.sendUserId)){const i={messageId:e.messageId,sendUserId:e.sendUserId||"",sendUserNickName:e.sendUserNickName||"",content:e.messageContent,messageContent:e.messageContent,sendTime:e.sendTime||Date.now()};y.value.push(i),ne(e.sendUserId),D.clearUnread(e.sendUserId)}}return Te(()=>{U(),O(),V.on(H.CHAT_TEXT_MESSAGE,b),V.on(H.CHAT_MEDIA_MESSAGE,b)}),Ue(()=>{V.off(H.CHAT_TEXT_MESSAGE,b),V.off(H.CHAT_MEDIA_MESSAGE,b)}),Ee(A,e=>{e||(_.value=null,y.value=[])}),(e,t)=>{const i=h("el-input"),p=h("el-button"),g=h("el-tag"),ee=h("el-icon"),te=h("el-empty"),Ce=h("el-badge"),F=h("el-dropdown-item"),Ie=h("el-dropdown-menu"),ke=h("el-dropdown"),we=h("el-dialog");return n(),C(Ke,null,{default:l(()=>{var ae;return[a("div",Ye,[a("div",Ze,[a("div",je,[a("div",qe,[o(i,{modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=s=>S.value=s),placeholder:"搜索用户ID添加好友","prefix-icon":r(le),clearable:"",onKeyup:Me(Y,["enter"])},null,8,["modelValue","prefix-icon"]),o(p,{type:"primary",icon:r(le),onClick:Y,loading:K.value},{default:l(()=>[...t[4]||(t[4]=[d(" 搜索 ",-1)])]),_:1},8,["icon","loading"])])]),u.value?(n(),v("div",Qe,[a("div",et,[a("div",tt,m(u.value.nickName.charAt(0).toUpperCase()),1),a("div",at,[a("div",st,m(u.value.nickName),1),a("div",nt,"ID: "+m(u.value.userId),1)]),a("div",lt,[u.value.status===r(E).SELF?(n(),C(g,{key:0,type:"info"},{default:l(()=>[...t[5]||(t[5]=[d("这是你自己",-1)])]),_:1})):u.value.status===r(E).FRIEND?(n(),C(g,{key:1,type:"success"},{default:l(()=>[...t[6]||(t[6]=[d("已是好友",-1)])]),_:1})):u.value.status===r(E).PENDING?(n(),C(g,{key:2,type:"warning"},{default:l(()=>[...t[7]||(t[7]=[d("申请中",-1)])]),_:1})):u.value.status===r(E).BLACKLISTED?(n(),C(g,{key:3,type:"danger"},{default:l(()=>[...t[8]||(t[8]=[d("已被拉黑",-1)])]),_:1})):u.value.status===r(E).BE_FRIEND?(n(),C(p,{key:4,type:"primary",size:"small",onClick:Z,loading:L.value},{default:l(()=>[...t[9]||(t[9]=[d(" 直接添加 ",-1)])]),_:1},8,["loading"])):(n(),C(p,{key:5,type:"primary",size:"small",onClick:Z,loading:L.value},{default:l(()=>[...t[10]||(t[10]=[d(" 添加好友 ",-1)])]),_:1},8,["loading"]))]),o(p,{icon:r(De),circle:"",size:"small",class:"close-btn",onClick:t[1]||(t[1]=s=>u.value=null)},null,8,["icon"])])])):$("",!0),a("div",ot,[a("div",it,[t[11]||(t[11]=a("h3",null,"我的好友",-1)),a("span",rt,m(x.value.length),1)]),R.value?(n(),v("div",ct,[o(ee,{class:"is-loading"},{default:l(()=>[o(r(oe))]),_:1}),t[12]||(t[12]=a("span",null,"加载中...",-1))])):x.value.length===0?(n(),v("div",ut,[o(te,{description:"暂无好友，搜索添加吧","image-size":80})])):(n(),v("div",dt,[(n(!0),v(J,null,ie(x.value,s=>(n(),v("div",{key:s.contactId,class:"contact-item",onClick:z=>q(s)},[a("div",{class:Le(["contact-avatar",{online:s.online}])},[d(m(s.contactNickName.charAt(0).toUpperCase())+" ",1),s.online?(n(),v("span",ft)):$("",!0)],2),a("div",pt,[a("div",mt,[d(m(s.contactNickName)+" ",1),X.value[s.contactId]?(n(),C(Ce,{key:0,value:X.value[s.contactId],class:"unread-badge"},null,8,["value"])):$("",!0)]),a("div",_t,m(s.online?"在线":"离线"),1)]),o(ke,{trigger:"click",onCommand:z=>_e(z,s),onClick:t[2]||(t[2]=ze(()=>{},["stop"]))},{dropdown:l(()=>[o(Ie,null,{default:l(()=>[o(F,{command:"chat",icon:r(Be)},{default:l(()=>[...t[13]||(t[13]=[d(" 发消息 ",-1)])]),_:1},8,["icon"]),o(F,{command:"delete",icon:r(Pe),divided:""},{default:l(()=>[...t[14]||(t[14]=[d(" 删除好友 ",-1)])]),_:1},8,["icon"]),o(F,{command:"blacklist",icon:r(be)},{default:l(()=>[...t[15]||(t[15]=[d(" 拉黑 ",-1)])]),_:1},8,["icon"])]),_:1})]),default:l(()=>[o(p,{icon:r(xe),circle:"",size:"small",class:"more-btn",loading:N.value===s.contactId},null,8,["icon","loading"])]),_:2},1032,["onCommand"])],8,vt))),128))]))])]),a("div",yt,[a("div",gt,[t[16]||(t[16]=a("h3",null,"好友申请",-1)),W.value>0?(n(),v("span",ht,m(W.value),1)):$("",!0)]),G.value?(n(),v("div",Ct,[o(ee,{class:"is-loading"},{default:l(()=>[o(r(oe))]),_:1}),t[17]||(t[17]=a("span",null,"加载中...",-1))])):B.value.length===0?(n(),v("div",It,[o(te,{description:"暂无好友申请","image-size":80})])):(n(),v("div",kt,[(n(!0),v(J,null,ie(B.value,s=>(n(),v("div",{key:s.applyId,class:"apply-item"},[a("div",wt,m(s.applyUserNickName.charAt(0).toUpperCase()),1),a("div",St,[a("div",Nt,m(s.applyUserNickName),1),a("div",At,m(de(s.lastApplyTime)),1)]),a("div",Tt,[s.status===r(f).INIT?(n(),v(J,{key:0},[o(p,{type:"primary",size:"small",onClick:z=>j(s.applyUserId,r(f).PASS),loading:P.value===s.applyUserId},{default:l(()=>[...t[18]||(t[18]=[d(" 同意 ",-1)])]),_:1},8,["onClick","loading"]),o(p,{size:"small",onClick:z=>j(s.applyUserId,r(f).REJECT),loading:P.value===s.applyUserId},{default:l(()=>[...t[19]||(t[19]=[d(" 拒绝 ",-1)])]),_:1},8,["onClick","loading"])],64)):(n(),C(g,{key:1,type:ve(s.status),size:"small"},{default:l(()=>[d(m(fe(s.status)),1)]),_:2},1032,["type"]))])]))),128))]))])]),o(we,{modelValue:A.value,"onUpdate:modelValue":t[3]||(t[3]=s=>A.value=s),title:"与 "+(((ae=_.value)==null?void 0:ae.contactNickName)||"")+" 聊天",width:"500px","close-on-click-modal":!1,class:"chat-dialog"},{default:l(()=>[a("div",Ut,[o(Fe,{messages:y.value,"current-user-id":r(M).userId,loading:k.value,"has-more":w.value,onSend:he,onLoadMore:ge},null,8,["messages","current-user-id","loading","has-more"])])]),_:1},8,["modelValue","title"])]}),_:1})}}}),Pt=Oe(Et,[["__scopeId","data-v-04fc6a1b"]]);export{Pt as default};
