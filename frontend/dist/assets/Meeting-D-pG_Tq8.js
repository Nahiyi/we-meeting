var Ge=Object.defineProperty;var Pe=(N,s,o)=>s in N?Ge(N,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):N[s]=o;var x=(N,s,o)=>Pe(N,typeof s!="symbol"?s+"":s,o);import{W as C,X as w,ad as F,d as Ie,y as se,c as E,v as L,F as ce,z as de,b as c,t as b,g as T,ae,s as $,w as S,e as d,H as ye,f as B,af as ue,D as we,h as q,o as p,u as je,r as I,a9 as Ke,a as ke,Y as Xe,n as qe,E as _,k as Je,I as Ye,G as Qe,B as G,ag as le,ah as Ze,P as oe,ai as et,aj as tt,ak as Te,al as nt,C as ot,am as st,an as at,i as it,J as rt,a3 as lt,a5 as ct,aa as dt,ao as ut,$ as gt,ap as ft,aq as mt,ar as vt,as as ht,at as pt,au as Ct,av as St}from"./index-DSboVXbR.js";import{b as wt,l as kt}from"./contact-D6i1HAeq.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Tt={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"}],iceCandidatePoolSize:10,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"};class It{constructor(){x(this,"peerConnections",new Map);x(this,"localStream",null);x(this,"meetingId","");x(this,"userId","");x(this,"initialized",!1);x(this,"onRemoteStream",null);x(this,"onStreamRemoved",null);x(this,"boundHandleOffer");x(this,"boundHandleAnswer");x(this,"boundHandleIceCandidate");this.boundHandleOffer=this.handleOffer.bind(this),this.boundHandleAnswer=this.handleAnswer.bind(this),this.boundHandleIceCandidate=this.handleIceCandidate.bind(this)}init(s,o,n,l){this.initialized&&this.cleanup(),this.meetingId=s,this.userId=o,this.onRemoteStream=n,this.onStreamRemoved=l,this.initialized=!0,C.on(w.WEBRTC_OFFER,this.boundHandleOffer),C.on(w.WEBRTC_ANSWER,this.boundHandleAnswer),C.on(w.WEBRTC_ICE_CANDIDATE,this.boundHandleIceCandidate),console.log("WebRTCManager initialized for meeting:",s,"user:",o)}async initLocalMedia(s=!0,o=!0){this.stopLocalMedia();try{if(!window.isSecureContext)throw console.error("getUserMedia requires a secure context (HTTPS or localhost)"),new Error("需要 HTTPS 或 localhost 环境才能访问摄像头/麦克风");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw console.error("getUserMedia is not supported in this browser"),new Error("当前浏览器不支持摄像头/麦克风访问");const n={video:s?{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:720},frameRate:{min:10,ideal:24,max:30},facingMode:"user"}:!1,audio:o?{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:{ideal:44100},channelCount:{ideal:1}}:!1};return console.log("Requesting media with constraints:",JSON.stringify(n)),this.localStream=await navigator.mediaDevices.getUserMedia(n),console.log("Got local stream with tracks:",this.localStream.getTracks().map(l=>`${l.kind}:${l.label}`)),this.localStream}catch(n){if(console.error("Failed to get local media:",n),s){if(n.name==="OverconstrainedError"||n.name==="NotReadableError"){console.log("Trying lower resolution...");try{return this.localStream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:320},height:{ideal:240},frameRate:{ideal:15}},audio:o?{echoCancellation:!0,noiseSuppression:!0}:!1}),console.log("Got low-res stream"),this.localStream}catch(l){console.error("Low-res also failed:",l)}}console.log("Video failed, trying audio only...");try{return this.localStream=await navigator.mediaDevices.getUserMedia({video:!1,audio:o?{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}:!1}),console.log("Got audio-only stream"),this.localStream}catch(l){console.error("Failed to get audio-only stream:",l)}}return n.name==="NotAllowedError"||n.name==="PermissionDeniedError"?console.error("用户拒绝了摄像头/麦克风权限"):n.name==="NotFoundError"||n.name==="DevicesNotFoundError"?console.error("未找到摄像头或麦克风设备"):n.name==="NotReadableError"||n.name==="TrackStartError"?console.error("摄像头或麦克风被其他程序占用"):n.name==="OverconstrainedError"?console.error("请求的媒体约束无法满足"):n.name==="TypeError"&&console.error("媒体约束配置错误"),null}}getLocalStream(){return this.localStream}createConnection(s){console.log("Creating PeerConnection for:",s,"hasLocalStream:",!!this.localStream);const o=this.peerConnections.get(s);if(o){const r=o.connectionState;if(r==="connecting"||r==="connected"||r==="new")return console.log("Reusing existing connection with:",s,"state:",r),o;console.log("Closing stale connection with:",s,"state:",r),this.closeConnection(s)}const n=new RTCPeerConnection(Tt);this.peerConnections.set(s,n);const l=this.localStream?this.localStream.getAudioTracks()[0]:null,v=this.localStream?this.localStream.getVideoTracks()[0]:null;if(l&&this.localStream?(n.addTransceiver(l,{direction:"sendrecv",streams:[this.localStream]}),console.log("Added audio transceiver with track")):(n.addTransceiver("audio",{direction:"recvonly"}),console.log("Added audio transceiver recvonly")),v&&this.localStream){const r=n.addTransceiver(v,{direction:"sendrecv",streams:[this.localStream]});this.optimizeVideoEncoding(r.sender),console.log("Added video transceiver with track")}else n.addTransceiver("video",{direction:"recvonly"}),console.log("Added video transceiver recvonly");return n.onicecandidate=r=>{r.candidate&&C.send({messageSendToType:F.USER,meetingId:this.meetingId,messageType:w.WEBRTC_ICE_CANDIDATE,sendUserId:this.userId,receiveUserId:s,messageContent:r.candidate})},n.ontrack=r=>{if(console.log("=== Received remote track ==="),console.log("From:",s),console.log("Track kind:",r.track.kind),console.log("Track enabled:",r.track.enabled),console.log("Track readyState:",r.track.readyState),console.log("Streams count:",r.streams.length),r.streams&&r.streams[0]){const h=r.streams[0];console.log("Stream id:",h.id),console.log("Stream tracks:",h.getTracks().map(u=>`${u.kind}:${u.enabled}`)),this.onRemoteStream?(console.log("Calling onRemoteStream callback for:",s),this.onRemoteStream(s,h)):console.error("onRemoteStream callback is not set!")}else console.warn("No stream in track event")},n.onconnectionstatechange=()=>{console.log(`PeerConnection state with ${s}:`,n.connectionState),n.connectionState==="connected"?(console.log(`Successfully connected to ${s}`),n.getReceivers().forEach(r=>{console.log(`Receiver track: ${r.track.kind}, id: ${r.track.id}, muted: ${r.track.muted}, enabled: ${r.track.enabled}`)})):n.connectionState==="failed"?(console.error(`Connection with ${s} failed, attempting to restart ICE`),n.restartIce()):n.connectionState==="disconnected"&&console.warn(`Connection with ${s} disconnected`)},n.oniceconnectionstatechange=()=>{console.log(`ICE connection state with ${s}:`,n.iceConnectionState),n.iceConnectionState==="failed"&&console.error(`ICE connection failed with ${s}`)},n}async optimizeVideoEncoding(s){try{const o=s.getParameters();(!o.encodings||o.encodings.length===0)&&(o.encodings=[{}]),o.encodings[0].maxBitrate=5e5,o.encodings[0].maxFramerate=24,o.encodings[0].priority="high",o.encodings[0].networkPriority="high",await s.setParameters(o),console.log("Video encoding optimized")}catch(o){console.warn("Failed to optimize video encoding:",o)}}async initiateConnection(s){if(console.log("Initiating connection to:",s,"hasLocalStream:",!!this.localStream),!this.localStream){console.log("Waiting for local stream before initiating connection...");let l=0;const v=3e3,r=100;for(;!this.localStream&&l<v;)await new Promise(h=>setTimeout(h,r)),l+=r;this.localStream?console.log("Local stream ready after",l,"ms"):console.warn("Local stream not ready after",v,"ms, proceeding with recvonly connection")}const o=this.peerConnections.get(s);if(o){const l=o.connectionState;if(l==="connected"){console.log("Already connected to:",s,"- skipping");return}if(l==="connecting"){console.log("Already connecting to:",s,"- skipping");return}}const n=this.createConnection(s);try{const l=await n.createOffer();await n.setLocalDescription(l);const v=this.localStream?this.localStream.getTracks().length>0:!1;console.log("Sending offer to:",s,"hasLocalTracks:",v),C.send({messageSendToType:F.USER,meetingId:this.meetingId,messageType:w.WEBRTC_OFFER,sendUserId:this.userId,receiveUserId:s,messageContent:l})}catch(l){console.error("Failed to create offer:",l)}}async handleOffer(s){var h;const o=s.sendUserId,l=(((h=s.messageContent)==null?void 0:h.sdp)||"").includes("a=recvonly");if(console.log("Received offer from:",o,"hasLocalStream:",!!this.localStream,"isRecvOnlyOffer:",l),!this.localStream){console.log("Local stream not ready, waiting...");let u=0;const k=5e3,g=100;for(;!this.localStream&&u<k;)await new Promise(R=>setTimeout(R,g)),u+=g;const m=this.localStream;m?console.log("Local stream ready after",u,"ms, tracks:",m.getTracks().length):console.warn("Local stream still not ready after",k,"ms, proceeding without it")}const v=this.peerConnections.get(o);if(v){const u=v.connectionState;if(u==="connected"){console.log("Received offer on existing connected connection, handling renegotiation");try{await v.setRemoteDescription(new RTCSessionDescription(s.messageContent));const k=await v.createAnswer();await v.setLocalDescription(k),console.log("Sending renegotiation answer to:",o),C.send({messageSendToType:F.USER,meetingId:this.meetingId,messageType:w.WEBRTC_ANSWER,sendUserId:this.userId,receiveUserId:o,messageContent:k})}catch(k){console.error("Failed to handle renegotiation offer:",k)}return}if(u==="connecting"||u==="new"){if(this.userId<o){console.log("Glare detected, my userId is smaller, ignoring offer from:",o);return}console.log("Glare detected, my userId is larger, accepting offer from:",o),this.closeConnection(o)}}const r=this.createConnection(o);try{await r.setRemoteDescription(new RTCSessionDescription(s.messageContent));const u=await r.createAnswer();if(await r.setLocalDescription(u),console.log("Sending answer to:",o),C.send({messageSendToType:F.USER,meetingId:this.meetingId,messageType:w.WEBRTC_ANSWER,sendUserId:this.userId,receiveUserId:o,messageContent:u}),l&&this.localStream)console.log("Received recvonly offer, will initiate reverse connection to send our video"),setTimeout(()=>{this.renegotiateConnection(o)},1500);else if(this.localStream){const k=this.localStream.getVideoTracks().length>0,g=this.localStream.getAudioTracks().length>0,m=r.getSenders().some(P=>{var y;return((y=P.track)==null?void 0:y.kind)==="video"}),R=r.getSenders().some(P=>{var y;return((y=P.track)==null?void 0:y.kind)==="audio"});(k&&!m||g&&!R)&&(console.log("Local stream has tracks but not sending, triggering renegotiation with:",o),setTimeout(()=>{this.renegotiateConnection(o)},1e3))}}catch(u){console.error("Failed to handle offer:",u)}}async renegotiateConnection(s){var n,l;const o=this.peerConnections.get(s);if(!(!o||!this.localStream)){if(o.connectionState!=="connected"&&o.connectionState!=="connecting"){console.log("Connection not ready for renegotiation:",o.connectionState);return}console.log("Renegotiating connection with:",s,"to update local tracks");try{const v=this.localStream.getAudioTracks()[0],r=this.localStream.getVideoTracks()[0],h=o.getTransceivers().find(g=>g.receiver.track.kind==="audio");h?v&&((n=h.sender.track)==null?void 0:n.id)!==v.id?(await h.sender.replaceTrack(v),h.direction="sendrecv",console.log("Updated audio transceiver track")):v&&h.direction!=="sendrecv"&&(h.direction="sendrecv",console.log("Updated audio transceiver direction")):v&&(o.addTransceiver(v,{direction:"sendrecv",streams:[this.localStream]}),console.log("Added new audio transceiver"));const u=o.getTransceivers().find(g=>g.receiver.track.kind==="video");if(u)r&&((l=u.sender.track)==null?void 0:l.id)!==r.id?(await u.sender.replaceTrack(r),u.direction="sendrecv",this.optimizeVideoEncoding(u.sender),console.log("Updated video transceiver track")):r&&u.direction!=="sendrecv"&&(u.direction="sendrecv",console.log("Updated video transceiver direction"));else if(r){const g=o.addTransceiver(r,{direction:"sendrecv",streams:[this.localStream]});this.optimizeVideoEncoding(g.sender),console.log("Added new video transceiver")}console.log("Creating renegotiation offer...");const k=await o.createOffer();await o.setLocalDescription(k),console.log("Sending renegotiation offer to:",s),C.send({messageSendToType:F.USER,meetingId:this.meetingId,messageType:w.WEBRTC_OFFER,sendUserId:this.userId,receiveUserId:s,messageContent:k})}catch(v){console.error("Failed to renegotiate connection:",v)}}}async handleAnswer(s){const o=s.sendUserId;console.log("Received answer from:",o);const n=this.peerConnections.get(o);if(n)try{await n.setRemoteDescription(new RTCSessionDescription(s.messageContent))}catch(l){console.error("Failed to set remote description:",l)}}async handleIceCandidate(s){const o=s.sendUserId;console.log("Received ICE candidate from:",o);const n=this.peerConnections.get(o);if(n)try{await n.addIceCandidate(new RTCIceCandidate(s.messageContent))}catch(l){console.error("Failed to add ICE candidate:",l)}}closeConnection(s){const o=this.peerConnections.get(s);o&&(o.close(),this.peerConnections.delete(s),console.log("Closed connection with:",s),this.onStreamRemoved&&this.onStreamRemoved(s))}closeAllConnections(){console.log("Closing all peer connections, count:",this.peerConnections.size),this.peerConnections.forEach((s,o)=>{s.close(),this.onStreamRemoved&&this.onStreamRemoved(o)}),this.peerConnections.clear()}stopLocalMedia(){this.localStream&&(console.log("Stopping local media tracks"),this.localStream.getTracks().forEach(s=>{try{s.stop(),console.log(`Stopped track: ${s.kind} (${s.label})`)}catch(o){console.error(`Failed to stop track: ${s.kind}`,o)}}),this.localStream=null)}toggleVideo(s){this.localStream&&this.localStream.getVideoTracks().forEach(o=>{o.enabled=s})}toggleAudio(s){this.localStream&&this.localStream.getAudioTracks().forEach(o=>{o.enabled=s})}cleanup(){console.log("WebRTCManager cleanup"),this.closeAllConnections(),this.stopLocalMedia(),this.initialized&&(C.off(w.WEBRTC_OFFER,this.boundHandleOffer),C.off(w.WEBRTC_ANSWER,this.boundHandleAnswer),C.off(w.WEBRTC_ICE_CANDIDATE,this.boundHandleIceCandidate),this.initialized=!1),this.meetingId="",this.userId="",this.onRemoteStream=null,this.onStreamRemoved=null}hasConnection(s){return this.peerConnections.has(s)}getConnectionCount(){return this.peerConnections.size}}const M=new It,yt={class:"member-list"},_t={class:"member-avatar"},Et={class:"member-detail"},Mt={class:"name"},Rt={key:0,class:"host-tag"},bt={key:1,class:"self-tag"},Nt={class:"member-status"},Ot={key:0,class:"member-actions"},At={key:0,class:"empty-tip"},xt=Ie({__name:"MemberList",props:{members:{},currentUserId:{},creatorId:{}},emits:["kick","blacklist"],setup(N,{emit:s}){const o=N,n=s,l=se(()=>o.currentUserId===o.creatorId);function v(h){n("kick",h)}function r(h){n("blacklist",h)}return(h,u)=>{const k=B("el-icon"),g=B("el-button");return p(),E("div",yt,[(p(!0),E(ce,null,de(N.members,m=>(p(),E("div",{key:m.userId,class:"member-item"},[c("div",_t,b(m.nickName.charAt(0)),1),c("div",Et,[c("span",Mt,b(m.nickName),1),m.memberType===T(ae).CREATOR?(p(),E("span",Rt,"主持人")):L("",!0),m.userId===N.currentUserId?(p(),E("span",bt,"我")):L("",!0)]),c("div",Nt,[m.videoOpen?(p(),$(k,{key:0,class:"status-on"},{default:S(()=>[d(T(ye))]),_:1})):(p(),$(k,{key:1,class:"status-off"},{default:S(()=>[d(T(ue))]),_:1}))]),l.value&&m.userId!==N.currentUserId&&m.memberType!==T(ae).CREATOR?(p(),E("div",Ot,[d(g,{type:"warning",size:"small",text:"",onClick:we(R=>v(m.userId),["stop"])},{default:S(()=>[...u[0]||(u[0]=[q(" 踢出 ",-1)])]),_:1},8,["onClick"]),d(g,{type:"danger",size:"small",text:"",onClick:we(R=>r(m.userId),["stop"])},{default:S(()=>[...u[1]||(u[1]=[q(" 拉黑 ",-1)])]),_:1},8,["onClick"])])):L("",!0)]))),128)),N.members.length===0?(p(),E("div",At," 暂无成员 ")):L("",!0)])}}}),Ut=_e(xt,[["__scopeId","data-v-841d511a"]]),$t={class:"meeting-container"},Lt={class:"meeting-header"},Vt={class:"header-left"},Dt={class:"meeting-info"},Bt={class:"meeting-name"},Ft={class:"meeting-id"},Ht={class:"meeting-time"},zt={class:"video-area"},Wt=["muted"],Gt={key:1,class:"video-placeholder"},Pt={class:"avatar"},jt={class:"member-info"},Kt={class:"member-name"},Xt={class:"meeting-controls"},qt={class:"invite-dialog"},Jt={class:"contact-list"},Yt=["onClick"],Qt={class:"contact-avatar"},Zt={class:"contact-info"},en={class:"contact-name"},tn={key:0,class:"selected-count"},nn=Ie({__name:"Meeting",setup(N){const s=Ke(),o=Je(),n=je(),l=I(s.params.meetingId||""),v=I(""),r=I("视频会议"),h=I(""),u=I(0);let k=null;const g=I([]),m=ke({}),R=ke({});function P(e){return!!m[e]}const y=I(!0),U=I(!0),J=I(!1),Y=I(!1),H=I(!1),ie=I([]),Q=I(!1),A=I([]),j=I(""),re=I(!1),ge=se(()=>{if(!j.value)return ie.value;const e=j.value.toLowerCase();return ie.value.filter(t=>t.contactNickName.toLowerCase().includes(e))});Xe(H,async e=>{if(e){A.value=[],j.value="",Q.value=!0;try{ie.value=await kt()}catch(t){console.error("加载联系人失败:",t),_.error("加载联系人失败")}finally{Q.value=!1}}});function Ee(e){const t=A.value.indexOf(e);t===-1?A.value.push(e):A.value.splice(t,1)}async function Me(){if(A.value.length===0){_.warning("请选择要邀请的联系人");return}re.value=!0;try{await vt(A.value),_.success(`已向 ${A.value.length} 位联系人发送邀请`),H.value=!1}catch(e){console.error("发送邀请失败:",e),_.error(e.message||"发送邀请失败")}finally{re.value=!1}}const V=I([]),D=I(!1),z=I(!0),Z=I(null),Re=se(()=>n.userId===h.value),be=se(()=>{const e=g.value.length;return e<=1?"grid-1":e<=2?"grid-2":e<=4?"grid-4":e<=6?"grid-6":"grid-9"});function Ne(e,t){if(t){R[e]=t;const i=m[e];if(i)t.srcObject=i;else if(e===n.userId){const f=M.getLocalStream();f&&(m[e]=f,t.srcObject=f)}}}function Oe(e){const t=Math.floor(e/3600),i=Math.floor(e%3600/60),f=e%60;return t>0?`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}`:`${i.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}`}function Ae(){o.push("/")}async function xe(){try{const e=await M.initLocalMedia(y.value,U.value);e?(m[n.userId]=e,await le(),R[n.userId]&&(R[n.userId].srcObject=e)):(_.warning("无法获取摄像头/麦克风权限，请检查浏览器设置"),y.value=!1,U.value=!1)}catch(e){console.error("初始化媒体失败:",e),window.isSecureContext?e.name==="NotAllowedError"?_.warning("您拒绝了摄像头/麦克风权限，请在浏览器设置中允许"):e.name==="NotFoundError"?_.warning("未检测到摄像头或麦克风设备"):e.name==="NotReadableError"?_.warning("摄像头或麦克风被其他程序占用"):_.warning("无法获取摄像头/麦克风权限"):_.error("请使用 HTTPS 或 localhost 访问，否则无法使用摄像头"),y.value=!1,U.value=!1}}function Ue(){y.value=!y.value,M.toggleVideo(y.value);const e=g.value.find(t=>t.userId===n.userId);e&&(e.videoOpen=y.value),C.send({messageSendToType:F.GROUP,meetingId:l.value,messageType:w.MEETING_USER_VIDEO_CHANGE,sendUserId:n.userId,messageContent:{videoOpen:y.value}})}function $e(){U.value=!U.value,M.toggleAudio(U.value)}async function Le(e,t){const i=t||"0",f=t?1:0;V.value.push({sendUserId:n.userId,sendUserNickName:n.nickName,content:e,messageContent:e,sendTime:Date.now(),receiveType:f,receiveUserId:i});try{await ht(e,w.CHAT_TEXT_MESSAGE,i)}catch(O){console.error("发送消息失败:",O)}}async function fe(){if(console.log("loadChatHistory 被调用, chatLoading:",D.value),D.value){console.log("chatLoading 为 true，跳过加载");return}D.value=!0;try{console.log("开始调用 loadMeetingMessages API...");const e=await Ze(1,20);console.log("loadMeetingMessages 返回结果:",e),e.list&&e.list.length>0?(V.value=e.list.map(me).reverse(),Z.value=Math.min(...e.list.map(t=>t.messageId)),z.value=e.list.length>=20,console.log("聊天消息已加载，数量:",V.value.length)):(z.value=!1,console.log("没有聊天消息"))}catch(e){console.error("加载聊天历史失败:",e)}finally{D.value=!1}}async function Ve(){if(!(D.value||!z.value||!Z.value)){D.value=!0;try{const e=await pt(Z.value,20);if(e.list&&e.list.length>0){const t=e.list.map(me).reverse();V.value=[...t,...V.value],Z.value=Math.min(...e.list.map(i=>i.messageId)),z.value=e.list.length>=20}else z.value=!1}catch(e){console.error("加载更多消息失败:",e)}finally{D.value=!1}}}function me(e){return{messageId:e.messageId,sendUserId:e.sendUserId,sendUserNickName:e.sendUserNickName,content:e.messageContent,messageContent:e.messageContent,sendTime:e.sendTime,receiveType:e.receiveType,receiveUserId:e.receiveUserId}}async function De(e){try{await oe.confirm("确定要踢出该成员吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ct(e),_.success("已踢出该成员")}catch(t){t!=="cancel"&&console.error("踢出成员失败:",t)}}async function Be(e){try{await oe.confirm("确定要拉黑该成员吗？拉黑后该成员将无法重新加入会议。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await St(e),_.success("已拉黑该成员")}catch(t){t!=="cancel"&&console.error("拉黑成员失败:",t)}}async function Fe(){try{await oe.confirm("确定要结束会议吗？所有成员都将被移出会议。","结束会议",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await et()}catch(e){e!=="cancel"&&console.error("结束会议失败:",e)}}async function He(){try{const e=g.value.length<=1,t=n.userId===h.value;let i="确定要离开会议吗？",f="离开会议";e?(i="您是会议中的最后一个成员，离开后会议将自动结束。确定要离开吗？",f="离开并结束会议"):t&&(i='您是会议主持人，离开后会议仍将继续。如需结束会议请点击"结束会议"按钮。确定要离开吗？'),await oe.confirm(i,f,{confirmButtonText:"确定",cancelButtonText:"取消",type:e?"warning":"info"}),await tt(),ee(),o.push("/")}catch(e){e!=="cancel"&&console.error("离开会议失败:",e)}}function ee(){M.cleanup(),k&&(clearInterval(k),k=null)}function ve(e){var i,f;const t=e.messageContent;if(t){if(t.meetingMemberList&&t.meetingMemberList.length>0){const O=y.value,K=M.getLocalStream(),W={};Object.keys(m).forEach(a=>{m[a]&&(W[a]=m[a])}),g.value=t.meetingMemberList.map(a=>({...a,videoOpen:a.userId===n.userId?O:a.videoOpen})),Object.keys(W).forEach(a=>{W[a]&&(m[a]=W[a])}),K&&(m[n.userId]=K,le(()=>{R[n.userId]&&(R[n.userId].srcObject=K)}));const te=g.value.find(a=>a.memberType===ae.CREATOR);te&&(h.value=te.userId);const ne=((i=t.newMember)==null?void 0:i.userId)===n.userId;console.log("=== handleMemberJoin ==="),console.log("My userId:",n.userId),console.log("newMember:",(f=t.newMember)==null?void 0:f.userId),console.log("iAmNewMember:",ne),console.log("Total members:",g.value.length),console.log("Current connections:",M.getConnectionCount()),g.value.forEach(a=>{if(a.userId!==n.userId){const X=M.hasConnection(a.userId);console.log(`Checking member ${a.userId}: hasConnection=${X}`),X||(ne?(console.log("I am new member, will initiate connection to:",a.userId),setTimeout(()=>{M.hasConnection(a.userId)?console.log("Connection already exists with:",a.userId):(console.log("Initiating delayed connection to:",a.userId),M.initiateConnection(a.userId))},800)):t.newMember&&t.newMember.userId===a.userId?(console.log("New member joined:",a.userId,"- I will also initiate connection"),setTimeout(()=>{M.hasConnection(a.userId)?console.log("Connection already exists with new member:",a.userId):(console.log("Existing member initiating connection to new member:",a.userId),M.initiateConnection(a.userId))},1500)):n.userId>a.userId?(console.log("Fallback: initiating connection to:",a.userId),M.initiateConnection(a.userId)):console.log("Fallback: waiting for connection from:",a.userId))}})}t.newMember&&t.newMember.userId!==n.userId&&_.info(`${t.newMember.nickName} 加入了会议`)}}function he(e){const t=e.messageContent,i=(t==null?void 0:t.exitUserId)||e.sendUserId;if(i){if(i===n.userId){const O=t==null?void 0:t.exitStatus;if(O===Te.KICK_OUT){_.warning("您已被移出会议"),ee(),o.push("/");return}else if(O===Te.BLACKLIST){_.error("您已被拉黑，无法重新加入此会议"),ee(),o.push("/");return}return}g.value=g.value.filter(O=>O.userId!==i),M.closeConnection(i),delete m[i];const f=e.sendUserNickName||"成员";_.info(`${f} 离开了会议`)}}function pe(e){const t=e.sendUserId,i=e.messageContent;if(t&&i){const f=g.value.find(O=>O.userId===t);f&&(f.videoOpen=i.videoOpen)}}function Ce(e){var t;if(e.sendUserId!==n.userId){const i=((t=e.messageContent)==null?void 0:t.receiveType)||0,f=e.receiveUserId||"0";if(i===1&&f!==n.userId)return;V.value.push({sendUserId:e.sendUserId||"",sendUserNickName:e.sendUserNickName||"",content:e.messageContent,messageContent:e.messageContent,sendTime:e.sendTime||Date.now(),receiveType:i,receiveUserId:f})}}function Se(e){_.warning("会议已结束"),ee(),o.push("/")}function ze(e,t){console.log("Received remote stream for user:",e,"tracks:",t.getTracks().length),m[e]=t;const i=g.value.find(f=>f.userId===e);i?(i.videoOpen=!0,console.log("Set videoOpen=true for member:",e)):console.warn("Member not found for userId:",e),le(()=>{R[e]?(R[e].srcObject=t,console.log("Set srcObject for user:",e)):(console.log("Video ref not found for user:",e,"will retry..."),setTimeout(()=>{R[e]?(R[e].srcObject=t,console.log("Retry: Set srcObject for user:",e)):console.error("Video ref still not found after retry for user:",e)},500))})}function We(e){delete m[e]}return qe(async()=>{if(l.value=s.params.meetingId,!l.value){_.error("会议ID无效"),o.push("/");return}try{const e=await Ye();e&&(r.value=e.meetingName,v.value=e.meetingNo,h.value=e.createUserId)}catch(e){console.error("获取会议信息失败:",e)}if(M.init(l.value,n.userId,ze,We),await xe(),g.value=[{userId:n.userId,nickName:n.nickName,joinTime:Date.now(),memberType:ae.NORMAL,status:0,videoOpen:y.value,sex:n.sex}],C.on(w.ADD_MEETING_ROOM,ve),C.on(w.EXIT_MEETING_ROOM,he),C.on(w.MEETING_USER_VIDEO_CHANGE,pe),C.on(w.CHAT_TEXT_MESSAGE,Ce),C.on(w.FINISH_MEETING,Se),!C.isConnected){console.log("等待 WebSocket 连接就绪...");let e=0;const t=5e3,i=100;for(;!C.isConnected&&e<t;)await new Promise(f=>setTimeout(f,i)),e+=i;if(!C.isConnected){console.error("WebSocket 连接超时"),_.error("连接会议服务器失败，请刷新页面重试");return}}console.log("WebSocket 已连接，复用现有连接"),console.log("Requesting meeting member list via INIT message..."),C.send({messageSendToType:F.GROUP,meetingId:l.value,messageType:w.INIT,sendUserId:n.userId}),k=window.setInterval(()=>{u.value++},1e3),console.log("预加载聊天历史...");try{await fe(),console.log("聊天历史加载完成，消息数量:",V.value.length)}catch(e){console.error("预加载聊天历史失败:",e)}}),Qe(()=>{k&&clearInterval(k),M.cleanup(),C.off(w.ADD_MEETING_ROOM,ve),C.off(w.EXIT_MEETING_ROOM,he),C.off(w.MEETING_USER_VIDEO_CHANGE,pe),C.off(w.CHAT_TEXT_MESSAGE,Ce),C.off(w.FINISH_MEETING,Se)}),(e,t)=>{const i=B("el-icon"),f=B("el-button"),O=B("el-drawer"),K=B("el-input"),W=B("el-empty"),te=B("el-dialog"),ne=ft("loading");return p(),E("div",$t,[c("div",Lt,[c("div",Vt,[d(f,{type:"text",class:"back-btn",onClick:Ae},{default:S(()=>[d(i,null,{default:S(()=>[d(T(nt))]),_:1}),t[8]||(t[8]=q(" 返回 ",-1))]),_:1}),c("div",Dt,[c("span",Bt,b(r.value),1),c("span",Ft,"会议号: "+b(v.value),1)])]),c("div",Ht,[d(i,null,{default:S(()=>[d(T(ot))]),_:1}),c("span",null,b(Oe(u.value)),1)])]),c("div",zt,[c("div",{class:G(["video-grid",be.value])},[(p(!0),E(ce,null,de(g.value,a=>(p(),E("div",{key:a.userId,class:G(["video-item",{"is-self":a.userId===T(n).userId}])},[a.videoOpen&&P(a.userId)?(p(),E("video",{key:0,ref_for:!0,ref:X=>Ne(a.userId,X),autoplay:"",playsinline:"",muted:a.userId===T(n).userId},null,8,Wt)):(p(),E("div",Gt,[c("div",Pt,b(a.nickName.charAt(0)),1)])),c("div",jt,[c("span",Kt,b(a.nickName),1),a.videoOpen?L("",!0):(p(),$(i,{key:0,class:"video-off"},{default:S(()=>[d(T(ue))]),_:1}))])],2))),128))],2)]),c("div",Xt,[c("div",{class:"control-item",onClick:Ue},[d(i,{size:24,class:G({"is-off":!y.value})},{default:S(()=>[y.value?(p(),$(T(ye),{key:0})):(p(),$(T(ue),{key:1}))]),_:1},8,["class"]),c("span",null,b(y.value?"关闭视频":"开启视频"),1)]),c("div",{class:"control-item",onClick:$e},[d(i,{size:24,class:G({"is-off":!U.value})},{default:S(()=>[U.value?(p(),$(T(st),{key:0})):(p(),$(T(at),{key:1}))]),_:1},8,["class"]),c("span",null,b(U.value?"静音":"取消静音"),1)]),c("div",{class:"control-item",onClick:t[0]||(t[0]=a=>J.value=!J.value)},[d(i,{size:24},{default:S(()=>[d(T(it))]),_:1}),c("span",null,"成员 ("+b(g.value.length)+")",1)]),c("div",{class:"control-item",onClick:t[1]||(t[1]=a=>H.value=!0)},[d(i,{size:24},{default:S(()=>[d(T(rt))]),_:1}),t[9]||(t[9]=c("span",null,"邀请",-1))]),c("div",{class:"control-item",onClick:t[2]||(t[2]=a=>Y.value=!Y.value)},[d(i,{size:24},{default:S(()=>[d(T(lt))]),_:1}),t[10]||(t[10]=c("span",null,"聊天",-1))]),Re.value?(p(),E("div",{key:0,class:"control-item end-meeting",onClick:Fe},[d(i,{size:24},{default:S(()=>[d(T(ct))]),_:1}),t[11]||(t[11]=c("span",null,"结束会议",-1))])):L("",!0),c("div",{class:"control-item leave",onClick:He},[d(i,{size:24},{default:S(()=>[d(T(dt))]),_:1}),t[12]||(t[12]=c("span",null,"离开会议",-1))])]),d(O,{modelValue:J.value,"onUpdate:modelValue":t[3]||(t[3]=a=>J.value=a),title:"会议成员",direction:"rtl",size:"320px"},{default:S(()=>[d(Ut,{members:g.value,"current-user-id":T(n).userId,"creator-id":h.value,onKick:De,onBlacklist:Be},null,8,["members","current-user-id","creator-id"])]),_:1},8,["modelValue"]),d(O,{modelValue:Y.value,"onUpdate:modelValue":t[4]||(t[4]=a=>Y.value=a),title:"会议聊天",direction:"rtl",size:"380px",onOpen:fe},{default:S(()=>[d(wt,{messages:V.value,"current-user-id":T(n).userId,loading:D.value,"has-more":z.value,"show-private-select":!0,members:g.value,onSend:Le,onLoadMore:Ve},null,8,["messages","current-user-id","loading","has-more","members"])]),_:1},8,["modelValue"]),d(te,{modelValue:H.value,"onUpdate:modelValue":t[7]||(t[7]=a=>H.value=a),title:"邀请联系人",width:"450px","close-on-click-modal":!1},{footer:S(()=>[A.value.length>0?(p(),E("span",tn," 已选择 "+b(A.value.length)+" 人 ",1)):L("",!0),d(f,{onClick:t[6]||(t[6]=a=>H.value=!1)},{default:S(()=>[...t[13]||(t[13]=[q("取消",-1)])]),_:1}),d(f,{type:"primary",loading:re.value,disabled:A.value.length===0,onClick:Me},{default:S(()=>[...t[14]||(t[14]=[q(" 发送邀请 ",-1)])]),_:1},8,["loading","disabled"])]),default:S(()=>[c("div",qt,[d(K,{modelValue:j.value,"onUpdate:modelValue":t[5]||(t[5]=a=>j.value=a),placeholder:"搜索联系人",clearable:"",class:"invite-search"},{prefix:S(()=>[d(i,null,{default:S(()=>[d(T(gt))]),_:1})]),_:1},8,["modelValue"]),ut((p(),E("div",Jt,[(p(!0),E(ce,null,de(ge.value,a=>(p(),E("div",{key:a.contactId,class:G(["contact-item",{"is-selected":A.value.includes(a.contactId)}]),onClick:X=>Ee(a.contactId)},[c("div",Qt,b(a.contactNickName.charAt(0)),1),c("div",Zt,[c("span",en,b(a.contactNickName),1),c("span",{class:G(["contact-status",{"is-online":a.online}])},b(a.online?"在线":"离线"),3)]),A.value.includes(a.contactId)?(p(),$(i,{key:0,class:"check-icon"},{default:S(()=>[d(T(mt))]),_:1})):L("",!0)],10,Yt))),128)),ge.value.length===0&&!Q.value?(p(),$(W,{key:0,description:"暂无联系人"})):L("",!0)])),[[ne,Q.value]])])]),_:1},8,["modelValue"])])}}}),ln=_e(nn,[["__scopeId","data-v-10137a04"]]);export{ln as default};
