# HTTP è¯·æ±‚å…¨é“¾è·¯ç”¨æˆ·ä¿¡æ¯ä¼ é€’æ–¹æ¡ˆæ€»ç»“

> **æ ¸å¿ƒé—®é¢˜**ï¼šç±»ä¼¼äº"ç”¨æˆ·ID"è¿™ç±»ä¿¡æ¯ï¼Œéœ€è¦æœ‰ä¸€ç§æ–¹å¼èƒ½å¤Ÿåœ¨å•ä¸ª HTTP è¯·æ±‚ï¼ˆå¯¹åº”å•ä¸ª HTTP çº¿ç¨‹ï¼‰ä¹‹å†…ï¼Œä»»æ„ä½ç½®éƒ½èƒ½è·å–åˆ°å½“å‰ç™»å½•ç”¨æˆ·çš„ IDã€æ˜µç§°ç­‰ä¿¡æ¯ã€‚

---

## ğŸ“‹ ç›®å½•

- [1. æ–¹æ¡ˆæ¦‚è§ˆ](#1-æ–¹æ¡ˆæ¦‚è§ˆ)
- [2. æ–¹æ¡ˆè¯¦è§£](#2-æ–¹æ¡ˆè¯¦è§£)
  - [2.1 ThreadLocalï¼ˆä¸»æµï¼‰](#21-threadlocalä¸»æµ)
  - [2.2 HttpRequest å±æ€§ + RequestContextHolder](#22-httprequest-å±æ€§-requestcontextholder)
  - [2.3 MDCï¼ˆæ—¥å¿— + ä¸Šä¸‹æ–‡åŒç”¨é€”ï¼Œæ¨èé…åˆ ThreadLocal ä½¿ç”¨ï¼‰](#23-mdcæ—¥å¿—-ä¸Šä¸‹æ–‡åŒç”¨é€”-æ¨èé…åˆ-threadlocal-ä½¿ç”¨)
  - [2.4 è‡ªå®šä¹‰ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆé€‚ç”¨äºå¾®æœåŠ¡ / åˆ†å¸ƒå¼åœºæ™¯ï¼‰](#24-è‡ªå®šä¹‰ä¸Šä¸‹æ–‡å¯¹è±¡é€‚ç”¨äºå¾®æœåŠ¡--åˆ†å¸ƒå¼åœºæ™¯)
  - [2.5 æ–¹æ³•å‚æ•°é€ä¼ ï¼ˆä¸æ¨èï¼Œä»…ä½œè¡¥å……ï¼‰](#25-æ–¹æ³•å‚æ•°é€ä¼ ä¸æ¨èä»…ä½œè¡¥å……)
- [3. æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©](#3-æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©)
- [4. æœ¬é¡¹ç›®å®æˆ˜æ¡ˆä¾‹](#4-æœ¬é¡¹ç›®å®æˆ˜æ¡ˆä¾‹)

---

## 1. æ–¹æ¡ˆæ¦‚è§ˆ

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èæŒ‡æ•° |
|------|---------|------|------|---------|
| **ThreadLocal** | å•æœº Web åº”ç”¨ | ç®€å•ç›´æ¥ã€æ€§èƒ½é«˜ | å¼‚æ­¥çº¿ç¨‹ä¼šä¸¢å¤±æ•°æ® | â­â­â­â­â­ |
| **HttpRequest + RequestContextHolder** | Spring Web é¡¹ç›® | æ— éœ€ä¼ å‚ã€ä»£ç ç®€æ´ | ä»…é™ HTTP è¯·æ±‚çº¿ç¨‹ | â­â­â­â­â­ |
| **MDC** | éœ€è¦æ—¥å¿—è¿½è¸ª | æ—¥å¿—å‹å¥½ã€æ’æŸ¥é—®é¢˜æ–¹ä¾¿ | ä¸»è¦ç”¨äºæ—¥å¿—ï¼Œä¸é€‚åˆä¸šåŠ¡é€»è¾‘ | â­â­â­â­ |
| **TransmittableThreadLocal** | å¼‚æ­¥çº¿ç¨‹åœºæ™¯ | è§£å†³å¼‚æ­¥ä¸¢å¤±é—®é¢˜ | éœ€è¦å¼•å…¥é¢å¤–ä¾èµ– | â­â­â­ |
| **åˆ†å¸ƒå¼è¿½è¸ª** | å¾®æœåŠ¡æ¶æ„ | è·¨æœåŠ¡ã€è·¨çº¿ç¨‹ | æ¶æ„å¤æ‚ã€æˆæœ¬é«˜ | â­â­â­â­ |
| **æ–¹æ³•å‚æ•°é€ä¼ ** | ç®€å•é¡¹ç›® | æ— éœ€é¢å¤–æŠ€æœ¯ | ä»£ç å†—ä½™ã€ç»´æŠ¤æˆæœ¬é«˜ | â­ |

---

## 2. æ–¹æ¡ˆè¯¦è§£

### 2.1 ThreadLocalï¼ˆä¸»æµï¼‰

#### åŸç†
- `ThreadLocal` æ˜¯ Java æä¾›çš„çº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å‰¯æœ¬
- åœ¨æ‹¦æˆªå™¨ä¸­å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ `ThreadLocal`ï¼Œåç»­è¯¥çº¿ç¨‹çš„æ‰€æœ‰ä»£ç éƒ½å¯ä»¥è®¿é—®

#### ä»£ç ç¤ºä¾‹

```java
// 1. ç”¨æˆ·ä¸Šä¸‹æ–‡å·¥å…·ç±»
public class UserContext {
    private static final ThreadLocal<UserTokenInfoDTO> USER_THREAD_LOCAL = new ThreadLocal<>();

    public static void setCurrentUser(UserTokenInfoDTO userInfo) {
        USER_THREAD_LOCAL.set(userInfo);
    }

    public static UserTokenInfoDTO getCurrentUser() {
        return USER_THREAD_LOCAL.get();
    }

    public static String getCurrentUserId() {
        UserTokenInfoDTO userInfo = getCurrentUser();
        return userInfo != null ? userInfo.getUserId() : null;
    }

    public static void clear() {
        USER_THREAD_LOCAL.remove();
    }
}

// 2. æ‹¦æˆªå™¨ä¸­ä½¿ç”¨
@Component
public class TokenInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        UserTokenInfoDTO userInfo = tokenService.validate(token);
        UserContext.setCurrentUser(userInfo);  // å­˜å…¥ ThreadLocal
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        UserContext.clear();  // è¯·æ±‚ç»“æŸæ—¶æ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼
    }
}

// 3. Controller ä¸­ä½¿ç”¨
@GetMapping("/loadMeeting")
public ResponseVO<List<Meeting>> loadMeeting() {
    String userId = UserContext.getCurrentUserId();  // ç›´æ¥è·å–
    return meetingService.loadByUserId(userId);
}
```

#### ä¼˜ç‚¹
- âœ… **ç®€å•ç›´æ¥**ï¼šJava åŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–æ¡†æ¶
- âœ… **æ€§èƒ½é«˜**ï¼šç›´æ¥å†…å­˜è®¿é—®ï¼Œæ— éœ€é¢å¤–å¼€é”€
- âœ… **çº¿ç¨‹éš”ç¦»**ï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹ï¼Œå¤©ç„¶çº¿ç¨‹å®‰å…¨

#### ç¼ºç‚¹
- âŒ **å¼‚æ­¥çº¿ç¨‹ä¸¢å¤±**ï¼šä½¿ç”¨ `@Async`ã€çº¿ç¨‹æ± æ—¶ï¼Œå­çº¿ç¨‹æ— æ³•è·å–çˆ¶çº¿ç¨‹çš„ ThreadLocal æ•°æ®
- âŒ **éœ€è¦æ‰‹åŠ¨æ¸…ç†**ï¼šè¯·æ±‚ç»“æŸæ—¶å¿…é¡»è°ƒç”¨ `remove()`ï¼Œå¦åˆ™ä¼šå¯¼è‡´**å†…å­˜æ³„æ¼**

#### é€‚ç”¨åœºæ™¯
- å•æœº Web åº”ç”¨
- æ— å¼‚æ­¥çº¿ç¨‹å¤„ç†çš„åœºæ™¯

---

### 2.2 HttpRequest å±æ€§ + RequestContextHolder

#### æ ¸å¿ƒåŸç†

**RequestContextHolder** æ˜¯ Spring Web æ¡†æ¶æä¾›çš„çº¿ç¨‹ä¸Šä¸‹æ–‡å·¥å…·ç±»ï¼š

1. **åº•å±‚æœºåˆ¶**ï¼šä½¿ç”¨ `ThreadLocal` å­˜å‚¨å½“å‰è¯·æ±‚çš„ `RequestAttributes` å¯¹è±¡
2. **æ ¸å¿ƒä»·å€¼**ï¼šåœ¨é Controller å±‚ï¼ˆServiceã€Util ç±»ï¼‰è„±ç¦»è¯·æ±‚å‚æ•°ä¼ é€’çš„åœºæ™¯ä¸‹ï¼Œèƒ½è·¨å±‚è·å–å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡
3. **çº¿ç¨‹ç»‘å®š**ï¼šæ¯ä¸ª HTTP è¯·æ±‚å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹ï¼Œä¿è¯å½“å‰çº¿ç¨‹æ‹¿åˆ°çš„ä¸€å®šæ˜¯æœ¬æ¬¡è¯·æ±‚çš„ä¸Šä¸‹æ–‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       HTTP è¯·æ±‚çº¿ç¨‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  RequestContextHolder (ThreadLocal)                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  RequestAttributes                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€â”€ HttpServletRequest                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚   â””â”€â”€ Attribute: "currentUser"           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚       â””â”€â”€ UserTokenInfoDTO               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â””â”€â”€ HttpServletResponse                    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â†‘                                 â”‚
â”‚                         â”‚ å…¨å±€è®¿é—®                         â”‚
â”‚          Controller â”€â”€â”€â”€â”¼â”€â”€ Service â”€â”€â”€ Mapper            â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸ "HttpRequest å±æ€§æ–¹æ¡ˆ" çš„å…³ç³»

| ç»´åº¦ | HttpRequest ç›´æ¥ä¼ é€’ | RequestContextHolder å°è£… |
|------|---------------------|--------------------------|
| **æœ¬è´¨** | å°†ç”¨æˆ· ID å­˜å…¥ `request.setAttribute()` | å®Œå…¨ç›¸åŒï¼Œéƒ½æ˜¯å­˜å…¥ Request å±æ€§ |
| **ä¼ é€’æ–¹å¼** | **å±€éƒ¨ä¼ é€’**ï¼šController ä¼  Service ä¼  Service | **å…¨å±€è·å–**ï¼šæ— éœ€ä¼ é€’ï¼Œç›´æ¥æ‹¿ |
| **ä»£ç ç®€æ´åº¦** | âŒ æ¯ä¸ªæ–¹æ³•éƒ½è¦åŠ  `HttpServletRequest request` å‚æ•° | âœ… ç›´æ¥è°ƒç”¨å·¥å…·ç±»è·å– |
| **é€‚ç”¨ä½ç½®** | ä»…é™æœ‰ request å¯¹è±¡çš„åœ°æ–¹ | å…¨é“¾è·¯ä»»æ„ä½ç½® |

**ç»“è®º**ï¼š`RequestContextHolder` æœ¬è´¨æ˜¯ "HttpRequest å±æ€§æ–¹æ¡ˆ" çš„å…¨å±€å°è£…ç‰ˆæœ¬ã€‚

#### å®Œæ•´å®ç°ç¤ºä¾‹

**æ­¥éª¤1ï¼šåˆ›å»ºç”¨æˆ·ä¸Šä¸‹æ–‡å·¥å…·ç±»**

```java
package cn.clazs.easymeeting.context;

import cn.clazs.easymeeting.entity.dto.UserTokenInfoDTO;
import cn.clazs.easymeeting.exception.BusinessException;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import jakarta.servlet.http.HttpServletRequest;

/**
 * ç”¨æˆ·ä¸Šä¸‹æ–‡å·¥å…·ç±»
 * åŸºäº RequestContextHolder å®ç°ï¼Œåœ¨å•æ¬¡è¯·æ±‚é“¾è·¯ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
 */
public class UserContext {

    private static final String CURRENT_USER = "currentUser";

    /**
     * è·å–å½“å‰è¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯
     */
    public static UserTokenInfoDTO getCurrentUser() {
        HttpServletRequest request = getRequest();
        UserTokenInfoDTO userInfo = (UserTokenInfoDTO) request.getAttribute(CURRENT_USER);

        if (userInfo == null) {
            throw new BusinessException("ç”¨æˆ·æœªç™»å½•æˆ–ç™»å½•å·²å¤±æ•ˆ");
        }

        return userInfo;
    }

    /**
     * è·å–å½“å‰ç”¨æˆ· ID
     */
    public static String getCurrentUserId() {
        return getCurrentUser().getUserId();
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·æ˜µç§°
     */
    public static String getCurrentUserNickName() {
        return getCurrentUser().getNickName();
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·çš„å½“å‰ä¼šè®® ID
     */
    public static String getCurrentMeetingId() {
        return getCurrentUser().getCurrentMeetingId();
    }

    /**
     * è®¾ç½®å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆé€šå¸¸åœ¨æ‹¦æˆªå™¨ä¸­è°ƒç”¨ï¼‰
     */
    public static void setCurrentUser(UserTokenInfoDTO userInfo) {
        getRequest().setAttribute(CURRENT_USER, userInfo);
    }

    /**
     * è·å–å½“å‰è¯·æ±‚çš„ HttpServletRequestï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰
     */
    private static HttpServletRequest getRequest() {
        ServletRequestAttributes attributes =
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();

        if (attributes == null) {
            throw new BusinessException(
                "å½“å‰çº¿ç¨‹ä¸å­˜åœ¨è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œå¯èƒ½æ˜¯åœ¨é Web ç¯å¢ƒä¸­è°ƒç”¨");
        }

        return attributes.getRequest();
    }

    /**
     * æ¸…é™¤å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œé€šå¸¸æ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼‰
     */
    public static void clearCurrentUser() {
        getRequest().removeAttribute(CURRENT_USER);
    }
}
```

**æ­¥éª¤2ï¼šåœ¨æ‹¦æˆªå™¨ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯**

```java
@Component
@RequiredArgsConstructor
public class TokenInterceptor implements HandlerInterceptor {

    private final RedisComponent redisComponent;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 1. ä» Header è·å– token
        String token = request.getHeader("token");

        // 2. éªŒè¯ token
        UserTokenInfoDTO userInfo = redisComponent.getUserTokenInfo(token);
        if (userInfo == null) {
            writeUnauthorized(response, "ç™»å½•å·²å¤±æ•ˆ");
            return false;
        }

        // 3. å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ UserContext
        UserContext.setCurrentUser(userInfo);

        return true;
    }
}
```

**æ­¥éª¤3ï¼šåœ¨ Controller/Service ä¸­ç›´æ¥ä½¿ç”¨**

```java
// Controller ä¸­ä½¿ç”¨ï¼ˆæ— éœ€ HttpServletRequest å‚æ•°ï¼‰
@RestController
@RequestMapping("/meeting")
public class MeetingController {

    @GetMapping("/loadMeeting")
    public ResponseVO<List<Meeting>> loadMeeting(
            @RequestParam(defaultValue = "1") Integer pageNo,
            @RequestParam(defaultValue = "10") Integer pageSize) {
        // ç›´æ¥é€šè¿‡ UserContext è·å–å½“å‰ç”¨æˆ· ID
        String userId = UserContext.getCurrentUserId();

        List<Meeting> meetings = meetingService.loadByUserId(userId, pageNo, pageSize);
        return ResponseVO.success(meetings);
    }

    @PostMapping("/exitMeeting")
    public ResponseVO<Void> exitMeeting() {
        // è·å–å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯å¯¹è±¡
        UserTokenInfoDTO currentUser = UserContext.getCurrentUser();
        meetingService.exitMeeting(currentUser);
        return ResponseVO.success();
    }
}

// Service ä¸­åŒæ ·å¯ä»¥ç›´æ¥ä½¿ç”¨
@Service
public class MeetingService {

    public void createMeeting(MeetingDTO dto) {
        // å³ä½¿æ²¡æœ‰ä¼ é€’ userId å‚æ•°ï¼Œä¹Ÿèƒ½ç›´æ¥è·å–
        String userId = UserContext.getCurrentUserId();

        Meeting meeting = new Meeting();
        meeting.setCreatorId(userId);
        meeting.setCreateTime(LocalDateTime.now());
        meetingMapper.insert(meeting);
    }
}
```

#### æ ¸å¿ƒæ³¨æ„äº‹é¡¹

**1. å¿…é¡»åšç©ºå€¼åˆ¤æ–­**
```java
private static HttpServletRequest getRequest() {
    ServletRequestAttributes attributes =
        (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();

    // âœ… å¿…é¡»åˆ¤ç©ºï¼Œå¦åˆ™é HTTP è¯·æ±‚åœºæ™¯ä¼š NPE
    if (attributes == null) {
        throw new BusinessException("å½“å‰çº¿ç¨‹ä¸å­˜åœ¨è¯·æ±‚ä¸Šä¸‹æ–‡");
    }

    return attributes.getRequest();
}
```

**2. é€‚ç”¨åœºæ™¯é™åˆ¶**

âŒ **ä»¥ä¸‹åœºæ™¯æ— æ³•ä½¿ç”¨ RequestContextHolderï¼š**
- `@Async` å¼‚æ­¥æ–¹æ³•
- çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†
- å®šæ—¶ä»»åŠ¡ `@Scheduled`
- æ¶ˆæ¯é˜Ÿåˆ—ç›‘å¬å™¨
- å•å…ƒæµ‹è¯•

âœ… **é€‚ç”¨åœºæ™¯ï¼š**
- Controller å±‚
- Service å±‚
- Mapper/DAO å±‚
- å·¥å…·ç±»ï¼ˆåœ¨ HTTP è¯·æ±‚çº¿ç¨‹å†…è°ƒç”¨ï¼‰

**3. å¼‚æ­¥åœºæ™¯çš„è§£å†³æ–¹æ¡ˆ**

å¦‚æœéœ€è¦åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆ Aï¼šæ‰‹åŠ¨ä¼ é€’ç”¨æˆ· IDï¼ˆæ¨èï¼‰**

```java
@GetMapping("/asyncTask")
public ResponseVO<Void> asyncTask() {
    // åœ¨ä¸»çº¿ç¨‹ä¸­è·å–ç”¨æˆ· ID
    String userId = UserContext.getCurrentUserId();

    // ä¼ é€’ç»™å¼‚æ­¥çº¿ç¨‹
    CompletableFuture.runAsync(() -> {
        // å¼‚æ­¥çº¿ç¨‹ä¸­ä½¿ç”¨ userId
        asyncService.doSomething(userId);
    });

    return ResponseVO.success();
}
```

**æ–¹æ¡ˆ Bï¼šæ‰‹åŠ¨ä¼ é€’ RequestAttributes**
```java
@GetMapping("/asyncTask")
public ResponseVO<Void> asyncTask() {
    // è·å–ä¸»çº¿ç¨‹çš„ RequestAttributes
    RequestAttributes attributes = RequestContextHolder.getRequestAttributes();

    CompletableFuture.runAsync(() -> {
        // è®¾ç½®åˆ°å­çº¿ç¨‹
        RequestContextHolder.setRequestAttributes(attributes);

        // å­çº¿ç¨‹ä¸­å¯ä»¥æ­£å¸¸ä½¿ç”¨ UserContext
        String userId = UserContext.getCurrentUserId();
        asyncService.doSomething(userId);

        // æ¸…ç†
        RequestContextHolder.resetRequestAttributes();
    });

    return ResponseVO.success();
}
```

#### ä¼˜ç‚¹
- âœ… **ä»£ç ç®€æ´**ï¼šæ— éœ€åœ¨æ¯ä¸ªæ–¹æ³•ä¸­æ·»åŠ  `HttpServletRequest request` å‚æ•°
- âœ… **å…¨é“¾è·¯å¯ç”¨**ï¼šControllerã€Serviceã€Mapper ä»»æ„å±‚éƒ½èƒ½è·å–
- âœ… **å¤ç”¨ Spring æœºåˆ¶**ï¼šæ— éœ€é¢å¤– ThreadLocalï¼Œåˆ©ç”¨ Spring å·²æœ‰çš„åŸºç¡€è®¾æ–½
- âœ… **ç±»å‹å®‰å…¨**ï¼šæä¾›ä¸“é—¨çš„æ–¹æ³•è·å–ç‰¹å®šå­—æ®µï¼Œé¿å…ç±»å‹è½¬æ¢

#### ç¼ºç‚¹
- âŒ **ä»…é™ HTTP è¯·æ±‚çº¿ç¨‹**ï¼šå¼‚æ­¥åœºæ™¯éœ€æ‰‹åŠ¨ä¼ é€’
- âŒ **ä¾èµ– Spring Web**ï¼šä¸é€‚ç”¨äºé Web ç¯å¢ƒ

#### é€‚ç”¨åœºæ™¯
- **Spring Boot Web é¡¹ç›®ï¼ˆå¼ºçƒˆæ¨èï¼‰**
- éœ€è¦åœ¨å¤šå±‚æ¶æ„ä¸­è·å–ç”¨æˆ·ä¿¡æ¯çš„åœºæ™¯

---

### 2.3 MDCï¼ˆæ—¥å¿— + ä¸Šä¸‹æ–‡åŒç”¨é€”ï¼Œæ¨èé…åˆ ThreadLocal ä½¿ç”¨ï¼‰

#### åŸç†
- MDCï¼ˆMapped Diagnostic Contextï¼‰æ˜¯ Log4j/Logback æä¾›çš„ä¸Šä¸‹æ–‡å·¥å…·
- åº•å±‚ä¹Ÿæ˜¯ `ThreadLocal`ï¼Œä¸»è¦ç”¨äºæ—¥å¿—æ‰“å°ï¼Œä½†ä¹Ÿå¯ç”¨äºä¸šåŠ¡é€»è¾‘

#### ä»£ç ç¤ºä¾‹

```java
// æ‹¦æˆªå™¨ä¸­è®¾ç½®
@Component
public class TokenInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        String userId = getUserInfo().getUserId();
        MDC.put("userId", userId);  // å­˜å…¥ MDC
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        MDC.clear();  // è¯·æ±‚ç»“æŸæ—¶æ¸…ç†
    }
}

// logback-spring.xml é…ç½®æ—¥å¿—æ ¼å¼
<pattern>%d{yyyy-MM-dd HH:mm:ss} [%X{userId}] %-5level %logger - %msg%n</pattern>
// è¾“å‡ºç¤ºä¾‹ï¼š2024-01-22 10:30:15 [user_123] INFO  c.e.service.MeetingService - åˆ›å»ºä¼šè®®

// ä¸šåŠ¡ä¸­è·å–
public void someMethod() {
    String userId = MDC.get("userId");
}
```

#### ä¼˜ç‚¹
- âœ… **æ—¥å¿—å‹å¥½**ï¼šæ—¥å¿—ä¸­è‡ªåŠ¨å¸¦ä¸Š userIdï¼Œæ’æŸ¥é—®é¢˜ç¥å™¨
- âœ… **æ’æŸ¥é—®é¢˜æ–¹ä¾¿**ï¼šå¯ä»¥æ ¹æ® userId å¿«é€Ÿæ£€ç´¢æ—¥å¿—

#### ç¼ºç‚¹
- âŒ **ä¸é€‚åˆå¤æ‚ä¸šåŠ¡**ï¼šä¸»è¦è®¾è®¡ç”¨äºæ—¥å¿—ï¼Œä¸é€‚åˆå­˜å‚¨å¤æ‚å¯¹è±¡
- âŒ **ç±»å‹é™åˆ¶**ï¼šåªèƒ½å­˜å‚¨ String ç±»å‹

#### é€‚ç”¨åœºæ™¯
- ä¸»è¦ç”¨äºæ—¥å¿—è¿½è¸ª
- é…åˆ ThreadLocal ä½¿ç”¨ï¼ŒMDC ä¸“é—¨ç”¨äºæ—¥å¿—ï¼ŒThreadLocal ç”¨äºä¸šåŠ¡é€»è¾‘

---

### 2.4 è‡ªå®šä¹‰ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆé€‚ç”¨äºå¾®æœåŠ¡ / åˆ†å¸ƒå¼åœºæ™¯ï¼‰

#### æ–¹æ¡ˆ Aï¼šTransmittableThreadLocalï¼ˆTTLï¼‰

**é—®é¢˜èƒŒæ™¯**ï¼šæ™®é€š ThreadLocal åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­ä¼šä¸¢å¤±æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼šé˜¿é‡Œå¼€æºçš„ TTLï¼Œè§£å†³å¼‚æ­¥åœºæ™¯ä¸‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ä¼ é€’

```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>transmittable-thread-local</artifactId>
    <version>2.14.3</version>
</dependency>
```

```java
// ä½¿ç”¨ TTL æ›¿ä»£ ThreadLocal
public class UserContext {
    private static final TransmittableThreadLocal<UserTokenInfoDTO> USER_TTL =
        new TransmittableThreadLocal<>();

    public static void setCurrentUser(UserTokenInfoDTO userInfo) {
        USER_TTL.set(userInfo);
    }

    public static UserTokenInfoDTO getCurrentUser() {
        return USER_TTL.get();
    }
}

// éœ€è¦ä½¿ç”¨ TTL çš„çº¿ç¨‹æ± æˆ– ExecutorService
TtlExecutors.getTtlExecutorService(executorService);
```

#### æ–¹æ¡ˆ Bï¼šåˆ†å¸ƒå¼è¿½è¸ªï¼ˆTraceContextï¼‰

åŸºäº SkyWalkingã€Zipkinã€Spring Cloud Sleuth ç­‰é“¾è·¯è¿½è¸ªå·¥å…·ï¼š

```java
// Spring Cloud Sleuth ç¤ºä¾‹
@GetMapping("/test")
public ResponseVO<Void> test() {
    // è·å–è¿½è¸ª ID
    String traceId = MDC.get("traceId");

    // æŠŠ userId æ”¾å…¥ Span çš„ Baggage ä¸­ï¼Œå…¨é“¾è·¯ä¼ é€’
    Span.current().baggage("userId", UserContext.getCurrentUserId());

    return ResponseVO.success();
}
```

#### é€‚ç”¨åœºæ™¯
- **å¾®æœåŠ¡æ¶æ„**ï¼šè·¨æœåŠ¡ä¼ é€’ç”¨æˆ·ä¿¡æ¯
- **å¼‚æ­¥å¤„ç†åœºæ™¯**ï¼šéœ€è¦åœ¨çº¿ç¨‹æ± ã€æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¼ é€’ç”¨æˆ·ä¿¡æ¯

---

### 2.5 æ–¹æ³•å‚æ•°é€ä¼ ï¼ˆä¸æ¨èï¼Œä»…ä½œè¡¥å……ï¼‰

#### ç¤ºä¾‹
```java
// Controller
public ResponseVO<List<Meeting>> loadMeeting(HttpServletRequest request) {
    String userId = getUserIdFromRequest(request);
    return meetingService.loadByUserId(userId);
}

// Service
public List<Meeting> loadByUserId(String userId) {
    return meetingMapper.selectByUserId(userId);
}

// Mapper
public List<Meeting> selectByUserId(String userId);
```

#### ç¼ºç‚¹
- âŒ **ä»£ç å†—ä½™**ï¼šæ¯ä¸ªæ–¹æ³•éƒ½éœ€è¦åŠ å‚æ•°
- âŒ **ç»´æŠ¤æˆæœ¬é«˜**ï¼šå¦‚æœéœ€è¦æ–°å¢å­—æ®µï¼Œæ‰€æœ‰æ–¹æ³•éƒ½è¦æ”¹
- âŒ **ä»£ç ä¾µå…¥æ€§å¼º**ï¼šä¸šåŠ¡é€»è¾‘å’ŒæŠ€æœ¯ç»†èŠ‚è€¦åˆ

#### é€‚ç”¨åœºæ™¯
- æå…¶ç®€å•çš„é¡¹ç›®
- é—ç•™ç³»ç»Ÿæ”¹é€ æˆæœ¬é«˜æ—¶

---

## 3. æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©

### å†³ç­–æ ‘

```
æ˜¯å¦æ˜¯å¾®æœåŠ¡/åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ
â”œâ”€ æ˜¯ â†’ ä½¿ç”¨åˆ†å¸ƒå¼è¿½è¸ªï¼ˆSkyWalking/Sleuthï¼‰+ TTL
â””â”€ å¦ â†’ æ˜¯å¦æœ‰å¼‚æ­¥çº¿ç¨‹å¤„ç†ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ ThreadLocal + TTL
    â””â”€ å¦ â†’ æ˜¯å¦æ˜¯ Spring Web é¡¹ç›®ï¼Ÿ
        â”œâ”€ æ˜¯ â†’ RequestContextHolder + HttpRequest å±æ€§
        â””â”€ å¦ â†’ è‡ªå®šä¹‰ ThreadLocal
```

### æ¨èæ–¹æ¡ˆç»„åˆ

**1. å•æœº Spring Boot é¡¹ç›®ï¼ˆæœ¬é¡¹ç›®çš„é€‰æ‹©ï¼‰**
```
HttpRequest å±æ€§ + RequestContextHolderï¼ˆä¸»è¦ï¼‰ + MDCï¼ˆæ—¥å¿—è¾…åŠ©ï¼‰
```
- ä¸šåŠ¡é€»è¾‘ï¼šä½¿ç”¨ `RequestContextHolder` å°è£…çš„ `UserContext`
- æ—¥å¿—è¿½è¸ªï¼šä½¿ç”¨ `MDC` è®°å½• userId

**2. å¾®æœåŠ¡/åˆ†å¸ƒå¼é¡¹ç›®**
```
åˆ†å¸ƒå¼è¿½è¸ªï¼ˆSkyWalkingï¼‰ + TransmittableThreadLocal + MDC
```

**3. é«˜å¹¶å‘å¼‚æ­¥å¤„ç†é¡¹ç›®**
```
TransmittableThreadLocal + çº¿ç¨‹æ±  TTL è£…é¥°å™¨
```

---

## 4. æœ¬é¡¹ç›®å®æˆ˜æ¡ˆä¾‹

### å½“å‰å®ç°æ–¹æ¡ˆ

æœ¬é¡¹ç›®ä½¿ç”¨ **HttpRequest å±æ€§ + RequestContextHolder** æ–¹æ¡ˆï¼š

#### æ ¸å¿ƒæ–‡ä»¶

1. **`UserContext.java`** - ç”¨æˆ·ä¸Šä¸‹æ–‡å·¥å…·ç±»
   ```java
   public static String getCurrentUserId() {
       return getCurrentUser().getUserId();
   }
   ```

2. **`TokenInterceptor.java`** - æ‹¦æˆªå™¨ä¸­è®¾ç½®ç”¨æˆ·ä¿¡æ¯
   ```java
   UserContext.setCurrentUser(userInfo);
   ```

3. **`MeetingController.java`** - Controller ä¸­ä½¿ç”¨
   ```java
   // âŒ é‡æ„å‰ï¼šæ¯ä¸ªæ–¹æ³•éƒ½è¦åŠ  HttpServletRequest request å‚æ•°
   public ResponseVO<List<Meeting>> loadMeeting(HttpServletRequest request) {
       UserTokenInfoDTO user = (UserTokenInfoDTO) request.getAttribute(CURRENT_USER);
       String userId = user.getUserId();
       // ...
   }
   
   // âœ… é‡æ„åï¼šç›´æ¥é€šè¿‡ UserContext è·å–
   public ResponseVO<List<Meeting>> loadMeeting() {
       String userId = UserContext.getCurrentUserId();
       // ...
   }
   ```

#### é‡æ„æ•ˆæœ

**ä¼˜åŒ–å‰ï¼š**
- æ¯ä¸ªæ–¹æ³•éƒ½éœ€è¦ `HttpServletRequest request` å‚æ•°
- éœ€è¦æ‰‹åŠ¨ç±»å‹è½¬æ¢ï¼š`(UserTokenInfoDTO) request.getAttribute(CURRENT_USER)`
- ä»£ç å†—ä½™ï¼Œ14 å¤„é‡å¤ä»£ç 

**ä¼˜åŒ–åï¼š**
- æ— éœ€ `HttpServletRequest` å‚æ•°
- ä¸€è¡Œä»£ç è·å–ï¼š`UserContext.getCurrentUserId()`
- ä»£ç ç®€æ´ï¼Œç»´æŠ¤æˆæœ¬ä½

### Spring MVC å‚æ•°è§£æåŸç†è¡¥å……

**ä¸ºä»€ä¹ˆ HttpServletRequest å¯ä»¥ç›´æ¥æ³¨å…¥åˆ° Controller æ–¹æ³•ä¸­ï¼Ÿ**

è¿™ä¸æ˜¯ä¼ ç»Ÿçš„ä¾èµ–æ³¨å…¥ï¼Œè€Œæ˜¯ Spring MVC çš„ **HandlerMethodArgumentResolver** æœºåˆ¶ï¼š

```java
// Spring MVC å†…éƒ¨å®ç°
public class ServletRequestMethodArgumentResolver implements HandlerMethodArgumentResolver {
    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        // æ”¯æŒ HttpServletRequestã€HttpServletResponse ç­‰ Servlet API ç±»å‹
        return HttpServletRequest.class.isAssignableFrom(parameter.getParameterType());
    }

    @Override
    public Object resolveArgument(...) {
        // ä» RequestContextHolder ä¸­è·å–å½“å‰è¯·æ±‚
        return webRequest.getNativeRequest(HttpServletRequest.class);
    }
}
```

**ç»“è®º**ï¼š`HttpServletRequest` èƒ½æ³¨å…¥åˆ° Controllerï¼Œåº•å±‚ä¹Ÿæ˜¯é€šè¿‡ `RequestContextHolder` å®ç°çš„ï¼

---

## 5. æ€»ç»“

| æ–¹æ¡ˆ | æ¨èåº¦ | æ ¸å¿ƒä¼˜åŠ¿ | å…¸å‹åº”ç”¨ |
|------|--------|----------|----------|
| **HttpRequest + RequestContextHolder** | â­â­â­â­â­ | ä»£ç ç®€æ´ã€å…¨é“¾è·¯å¯ç”¨ | Spring Web é¡¹ç›®ï¼ˆæœ¬é¡¹ç›®ï¼‰ |
| **ThreadLocal** | â­â­â­â­â­ | ç®€å•ç›´æ¥ã€æ€§èƒ½é«˜ | é€šç”¨åœºæ™¯ |
| **MDC** | â­â­â­â­ | æ—¥å¿—å‹å¥½ | æ—¥å¿—è¿½è¸ª |
| **TransmittableThreadLocal** | â­â­â­ | è§£å†³å¼‚æ­¥ä¸¢å¤± | å¼‚æ­¥çº¿ç¨‹åœºæ™¯ |
| **åˆ†å¸ƒå¼è¿½è¸ª** | â­â­â­â­ | è·¨æœåŠ¡ä¼ é€’ | å¾®æœåŠ¡æ¶æ„ |
| **æ–¹æ³•å‚æ•°é€ä¼ ** | â­ | ç®€å•ç²—æš´ | ä¸æ¨è |

**æœ€ä½³å®è·µå»ºè®®ï¼š**
1. **å•æœº Spring Web é¡¹ç›®**ï¼šHttpRequest + RequestContextHolderï¼ˆæœ¬é¡¹ç›®çš„é€‰æ‹©ï¼‰
2. **éœ€è¦æ—¥å¿—è¿½è¸ª**ï¼šé…åˆ MDC ä½¿ç”¨
3. **å¾®æœåŠ¡æ¶æ„**ï¼šå¼•å…¥åˆ†å¸ƒå¼è¿½è¸ªæ¡†æ¶
4. **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨ TransmittableThreadLocal æˆ–æ‰‹åŠ¨ä¼ é€’å‚æ•°

---

## å‚è€ƒæ–‡æ¡£

- Spring Framework Documentation: RequestContextHolder
- Logback Documentation: MDC
- Alibaba TTL: TransmittableThreadLocal
- Spring Cloud Sleuth: Distributed Tracing

---

> **Author**ï¼šClazs
> **æ–‡æ¡£ç»´æŠ¤**ï¼šæœ¬é¡¹ç›®æŠ€æœ¯ç¬”è®°æ–‡æ¡£
> **æœ€åæ›´æ–°**ï¼š2026-01-22
